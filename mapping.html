<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>

     <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/> 

     <style> 
     #map { height: 500px; 
            };

    #reset {
        background-color: darkcyan;
    };
    </style> 
</head>

<body>

   <div id="map"></div>

     <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

     <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
  
    <script> 
    var map = L.map('map').setView([43.6532, -79.3832], 13);


    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
}).addTo(map);

    function getGPS(callback) {
        navigator.geolocation.watchPosition((position) => {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude; 
        const acc = position.coords.accuracy;
        callback(lat,lon,acc)

        }
    )}  
     
    
    let myTrail = []
    let pathlines; 
    let totalDistance = 0
    window.lock = false

    getGPS((lat, lon, acc) => {

        if (!window.marker) {
            window.marker = L.marker([lat,lon]).addTo(map)
            map.setView([lat,lon], 18)
            
        } else {
            window.marker.setLatLng([lat,lon])
        } 

        

        if (myTrail.length > 1) {
            
            let myTrails = myTrail[myTrail.length -1]
            
            let diff = Math.abs(myTrails[0] - lat) + Math.abs(myTrails[1] - lon) 

            if (diff < 0.00003) 
            return;
            
            const point1 = L.latLng(myTrails[0], myTrails[1])
            const point2 = L.latLng(lat,lon)
            const distanceDiff = point1.distanceTo(point2)
            totalDistance = totalDistance + distanceDiff
            console.log('당신 걸은 총 거리는' + totalDistance) 
        
        } 

            document.getElementById('TotalDistance').onclick = function () { 
            alert("총 거리는" + totalDistance.toFixed(4)+'m 입니다')   
 
        } 


        myTrail.push([lat,lon])
        marker.setLatLng([lat, lon]);
        map.panTo([lat, lon]);
        marker.setTooltipContent(`위도: ${lat.toFixed(4)}, 경도 ${lon.toFixed(4)}`)
        console.log(myTrail)



       

        if (!window.circle) {
            window.circle = L.circle ([lat,lon], {
                color: 'blue',
                radius: acc
            }).addTo(map);
        } else { 
            window.circle.setLatLng([lat, lon])
            window.circle.setRadius(acc);
        }

        if (myTrail.length > 1) {
            if (!window.pathlines) {
                window.pathlines = L.polyline(myTrail, {
                    color : 'blue',
                    weight: 5,
                    opacity: 0.6 
                }).addTo(map)
            } 
         else {
            window.pathlines.addLatLng([lat, lon])

        }
    }

    


    if (!window.lock) {
    var position = L.control({position:"bottomleft"})
        
    position.onAdd = function(map) {
        var Img = L.DomUtil.create('img');
        Img.src = "https://cdn-icons-png.flaticon.com/512/854/854878.png";
        Img.style.width = "40px"
        Img.style.height = "50px"
        Img.style.cursor = "pointer"

        Img.onmouseover = function() {
            Img.style.transform = "scale(1.2)"
            Img.style.opacity = "0.6"
        }

        Img.onmouseout = function () {
            Img.style.transform = "scale(1)"
            Img.style.opacity = "1"


        return Img
    

    } 
    window.lock = true
    position.addTo(map)     
}
    console.log(myTrail)

    document.getElementById('myPath').onclick = function() {
        marker.setLatLng([lat, lon])
        map.setView([lat,lon],18)
        
        
    }
  

    document.getElementById('reset').onclick = function () {
        myTrail = [];
        totalDistance = 0;

        if (window.pathlines) {
            map.removeLayer(window.pathlines)
            window.pathlines  = null;
        }
    }
}
    })   



</script> 

<button id = "reset"> 길을 초기화하기 </button>
<button id = "myPath"> 내 길로 돌아가기 </button>
<button id = "TotalDistance"> 총 거리 계산하기</button>
</body>

</html>